
---
title: "Contraception use since the 90s"
author: 'Registration number: 230170335'
date: "30th April 2024"
output: 
  html_document:
    
    theme: journal
    toc: yes
    toc_float: true
    toc_collapsed: true
    highlight: haddock
    number_sections: true
    code_folding: show
  pdf_document: 
    toc: true
    toc_depth: 4
    number_sections: true
    highlight: haddock
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#to avoid the error message: setting CRAN without a mirror
#repos specifies the repository 
#CRAN (comprehensive R Archive Network) is the primary repository for packages
# the URL is the designated URL for CRAN 
options(repos = c(CRAN = "https://cloud.r-project.org"))
```

```{r libraries, include=FALSE}
#packages are installed nearer to the code where they are used, this is personal preference to see how they are used clearly
if(!require(tidyverse)){install.packages("tidyverse"); library(tidyverse)}
if(!require(here)){install.packages("here"); library(here)}
#when running the install.packages there is a warning message, trying to use CRAN without setting a mirror
#it is not advised  to install packages in markdown 
#require checks if the package is installed and returns true or false
# ! negates the result, if the package is not installed it returns true
#if the package is not installed the code in the curly brackets {} is run
#this means it will not try to install packages on other computers if they are already installed 
```

```{r, include=FALSE}
# read data into R and view
# if the data is downloaded from github, please make sure the datafile is in a folder called rawdata for this line of code to run 
womendata <- read_csv(here("rawdata","1990_2019_all_women.zip"))

```
# Data origins 
The data was found from a research article by Haakenstad et al., (2022) *https://doi.org/10.1016/S0140-6736(22)00936-9.*
The authors state that the data is a collection from 1162 surveys measuring womens current contraception use ages **15-49**, between 1970 to 2019 in 204 countries.
For this project, contracpetive use in Europe between 1991 and 2019 was investigated. 
15 contraceptive methods were measured **if more than one method was used then the most effective method was counted**.

The data is shared via Global Burden of Diease Collaboration Network.

Reference: Global Burden of Disease Collaborative Network. Global Burden of Disease Study 2019 (GBD 2019) Contraceptive Prevalence Estimates 1970-2019. Seattle, United States of America: Institute for Health Metrics and Evaluation (IHME), 2022.

#### Variables important to this project include 
* Measure --> this is everything that was measured including contraceptive types and demand satisfied with modern methods
* Mean --> this specifies the mean value for each measure for each year and country.
More is detailed in the code book. 
* age_group_name --> this divides the data into different age groups, this visualisation uses All age (15-49)
* Location_name --> the country for the estimate, this includes 204 countries
* Continent --> continent in which the country belongs to. Values include Asia, Europe, Oceania, Africa, Americas 
* Mean value --> This variable combines the original mean values for each year, each contraception, and each country. To create an overall mean for each year and contraception which is then represented as a percentage.

#### Here is the first few lines of the data 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
if(!require(knitr)){install.packages("knitr"); library(knitr)}

# the tables should fit the webpage, but in doing so completely distorts the pdf tables
#define a function called table fit
#within this knitr::is_html_output/latex_output checks the knitted output
#if the output is html the tables will be returned modified to fit the page using knitr::kable
#table.attr allows for additional attributes to the table
# width:100% makes sure the table fits the webpage
#max-width: could be called here if there should be a limit on how wide the should be, however in this case, fitting to the webpage is fine
#defining fit_table allows for easy customization 
#make it pink and blue
fit_table<- function(data) {
  if (knitr::is_html_output()) {
    return(knitr::kable(data, format = "html", 
                        table.attr = 'style="width:100%; background-color: pink; border: 4px solid lightblue;"'))
  } else if (knitr::is_latex_output()) {
    return(knitr::kable(data))
  }
}

#print the table in respect to the fit_table function 
fit_table(head(womendata))

```
# Research Question 
### Have contraceptive use trends changed in the last few decades? 
This question comes from the apparent dissatisfaction of hormonal contraception among women, so it could be interesting to see if trends in use have changed. 
For this question all ages in the dataset are included in the visualisation.
However, only European countries are included. 

# Data Preperation 
### First, remove the age categories not needed, so only the all ages category is left
```{r removing age rows}
#cleaning up the data
#removing the rows that break down age groups as we only need to see combined age groups
#to remove certain rows based on number in a column ie: group id use the dplyr function 
#make a new data frame called filtered data
# %in% checks if the value of the given values in the vector are in the column name
# the ! symbol means 'not in' so removes the rows according values specified in the column specified... 
#It returns true for values not in the vector and false for those in the vector
#using a pipe to make the code more readable, if not it would look like...
# filtered_data <-  filter(womendata, !age_gorup_id %in% c(8, 9, 10, 11, 12, 13, 14, 27)) (27 is getting rid of age standardised)
filtered_data <- womendata %>% filter(!age_group_id %in% c(8, 9, 10, 11, 12, 13, 14, 27))
view(filtered_data)

# currently, the mean column is in a decimal format.
#for the end graph to look nicer, it should be as a percentage.
# giving the values the % sign now would convert the numbers into character data, so you can add the % when visualising the graph
```
Lets check that worked 
```{r removing age rows check}
print(paste ("now we have", nrow(filtered_data), "cases"))
```

### Second, Categorising the countries into continents
```{r continent, warning=FALSE, message=FALSE}
#to filter the data so that only certain countries are included in the graph, in order to make it cleaner
# first, turn the countries into continents to make filtering quicker
#install required packages
if(!require(countrycode)){install.packages("countrycode"); library(countrycode)}
filtered_data$Continent <- countrycode(sourcevar = filtered_data$location_name,
                                    origin = "country.name",
                                    destination = "continent")
view(filtered_data)
```
Lets check that worked by printing out the unique words in the continent column 
```{r continent check}
continent_words <- unique(filtered_data$Continent)
print(continent_words)
```

### Third, remove the continents not needed for the visualisation
```{r remove continent, warning=FALSE, message=FALSE}

#filter the dataset by continent, in this case, just europe
filtered_data_europe <- filtered_data %>%
  filter(Continent %in% c("Europe"))
view(filtered_data_europe)
```
Lets check that has worked by seeing how many rows include Europe vs the other Continents
```{r remove continent data check, warning=FALSE, message=FALSE}
#data check 
print(paste ("now we have", nrow(filtered_data_europe), "cases"))
#to check if europe is there
europe_rows <- filtered_data_europe[filtered_data_europe$Continent %in% c("Europe"), ]
fit_table(head(europe_rows))
#to check if other continents are removed from the dataset
other_rows <- filtered_data_europe[filtered_data_europe$Continent %in% c("Asia", "Africa", "Americas", "Oceania"), ]
print(other_rows)
```
### Now means need to be made for each measure and year regardless of the country 
```{r creating mean, warning=FALSE, message=FALSE}
#  Filter the dataset to include only the relevant columns
#the select function selects the relevant columns to retain
filtered_data_2 <- filtered_data_europe %>%
  select(year_id, measure, `mean`,location_name)
view(filtered_data_2)
#  Group by Year and Contraception_Type and calculate the mean Value
#group by groups the year_id and measure (contraceptive type) which creates a row with the same year and type of contraception
#summarise calculates the mean of the mean column for each group as created by the group_by() function
mean_data <- filtered_data_2 %>%
  group_by(year_id, measure) %>%
  summarise(mean_value = mean(`mean`, na.rm = TRUE))  
view(mean_data)
```
### Heres the first few lines of the filtered data
```{r show filtered, warning=FALSE, message=FALSE}
fit_table(head(mean_data))
```

```{r save final dataset, warning=FALSE, message=FALSE}
#install openxlsx package
#save the filtered data set
if(!require(openxlsx)){install.packages("openxlsx"); library(openxlsx)}
write.xlsx(mean_data, file.path("filtered_data", "mean_data.xlsx"))
```

# Visualisations 
## Inital visualisation 
To get a sense of the data, all variables in the measure column are included 

```{r inital visualisation, warning=FALSE, message=FALSE}
first_p <- ggplot(mean_data, aes(x = year_id, y = mean_value, color = measure)) +
  geom_line() +
  labs(title = "Mean Contraceptive Use Over Time",
       x = "Year",
       y = "Mean Contraceptive Use") +
  theme_minimal()
print(first_p)
```

```{r initial plot save,warning=FALSE, message=FALSE }
#specify the file 
plot_file <- here("plots", "first_plot.png")

# Saveing the plot to the specified file
ggsave(filename = plot_file, plot = first_p, device = "png", bg = "white", width = 8, height = 6, units = "in")
# bg white is to set the background white as its default is black
```
### Thats messy! And doesn't tell much about the data
In order for the plot to be meaningful, choosing specific measures would be best.

## Final visualisation

Measures chosen are:

* Condom prevalence
* Pill prevalence
* Implants prevalence
* Injections prevalence
* IUD prevalence

### This Visualisation should be creative and therefore needs some customising.
#### In line with academia a serif font would go nicely, defining the text theme now will keep the plot code less messy later on

```{r text, warning=FALSE, message=FALSE}
#lets define the theme for the different texts in the graph, choosing serif
#by coding this as 'theme_text' the code for the graph will be cleaner and easier to modify
#element_text() specifies font families
theme_text <- theme(
  #most text will me Arial regular
  text = element_text(family = "serif"),
  #main title should be bold
  plot.title = element_text(family = "serif" , face = "bold", size = 14),
  #subtitle should be italics
  plot.subtitle = element_text(family = "serif" , face = "italic"),
  #the legend title should also be bold
  legend.title = element_text(family = "serif", face = "bold", size = 14),
 
  legend.text = element_text(size = 14),
)
```

#### The colours should be nice too!
For fun, the blue chosen here is the RGB value of IKB 79 by Yves Klein
```{r blue, warning=FALSE, message=FALSE}
ikb <- "#002FA7" 
```
<img src="Images_for_markdown/IKB_79.jpg" alt="IKB_79" width="300"/>



Again, for fun the pink chosen here is from the Rigevidon (the pill) packaging 
The webiste used to calculate the rgba value is:https://imagecolorpicker.com/en
```{r pink, warning=FALSE, message=FALSE}
# for the pink used is from this website https://imagecolorpicker.com/en to determine the RBG values 
# turn rgba(189,35,87,255) into something R can read
# this is the pink that is used on the Rigevidon (contraceptive pill) packaging
pill_colour <- rgb(239,44,86, maxColorValue = 255) # maxColorValue sets the maximum value for each component
```
![the_pill_pic.jpg](Images_for_markdown/the_pill_Pic.jpg)

```{r custom colours, warning=FALSE, message=FALSE }
custom_colors <- c(
  "Condom prevalence" = ikb, 
  "Pill prevalence" = pill_colour,
  "Implants prevalence" = "green", 
  "Injections prevalence" = "orange", 
  "IUD prevalence" = "pink"
  
)
```
#### The legend should be clear
```{r legend, warning=FALSE, message=FALSE }
#this changes the size of the legend to make it clearer
#the legend may be a bit repetitive with the word prevalence reoccurring
custom_labels <- c(
  "Condom prevalence" = "Condoms",
  "Pill prevalence" = "The Pill",
  "Implants prevalence" = "Implants",
  "Injections prevalence" = "Injections",
  "IUD prevalence" = "IUD"
)
```
### The plot

```{r the plot, warning=FALSE, message=FALSE}
# the scales package here converts the y axis into a percentage 
# by changing the range between 1991 and 2019 the graph does not travel off of its limits
#unfortunately between 1990 and 2019 is 29, which is a prime number 
p <- ggplot(filter(mean_data, measure %in% c("Condom prevalence", "Pill prevalence", "Implants prevalence", "Injections prevalence", "IUD prevalence")),
       mapping= aes(x = year_id, y = mean_value, color = measure), frame = year_id) + #frame = is so that the graph can be a gif
  geom_line() +
  geom_point(size = 3, shape = 20) +
  labs(title = "Percentage of Contraceptive Use ",
       subtitle= "Between 1991 and 2019 in Europe, women aged between 15 and 49. ",
       x = "Year",
       y = "Mean Contraceptive Use",
       color = "Contraceptive Type") + # this is to add a title to the legend
  scale_y_continuous(labels = scales::percent)+
  scale_x_continuous(limits = c(1991, 2019), breaks = seq(1991, 2019, by = 4)) +  # Set x-axis limits and specify breaks every 4 years
  scale_color_manual(values = custom_colors,
                     labels = custom_labels) +
                     
  theme_minimal() +
  theme_text
print(p)
```

```{r plot save, warning=FALSE, message=FALSE}
#specify the file 
plot_file <- here("plots", "viz_230170335.png")

# Saveing the plot to the specified file
ggsave(filename = plot_file, plot = p, device = "png", bg = "white", width = 8, height = 6, units = "in")
# bg white is to set the background white as its default is black
```

# The plot could be better by animating it- Plot for assessment 
By animating the plot the time aspect is accentuated 

```{r,warning=FALSE, message=FALSE}
#install the relevant package
if(!require(gganimate)){install.packages("gganimate"); library(gganimate)}
if(!require(gifski)){install.packages("gifski"); library(gifski)}
#animating the plot
animated <- p+
  geom_point() +
  transition_manual(year_id, cumulative = TRUE) +
  ggtitle(expression('Percentage of Contraceptive Use in the year: {ifelse(frame + 1990 <= 2019, frame + 1990, 2019)}'))
#the next lines of code will allow this markdown script to be knit into both PDF and html 
#the use of 'if' will determine what code is run based on whether the knit is to html or pdf
if(knitr::is_html_output()){
  animated
}

if(knitr::is_html_output()){
  anim_save(here("plots" , "gif_230170335.gif"), animated, renderer = gifski_renderer())

}

if(!knitr::is_latex_output()){
  anim_save(here("plots" , "gif_230170335.gif"), animated, renderer = gifski_renderer())
}
```


# Summary
## Interpretation 
This graph may suggest that hormonal contraception use has not gone down drastically despite possible dissatisfaction with it. It does however show that condom use is increasing a lot. This could mean a lot of things, perhaps people are trying to be safer, it could mean that younger age populations, who are starting to engage in sexual activity more, need a form of contraception but don't want to use hormonal ones.
Of course, a limitation of this plot/the data used, is that it does not investigate whether people are happy with their contraception.
In wider context, this data could not inform researchers/medical professionals if women are unhappy with their hormonal contraception. But it can show that, despite side effects, many women stay on hormonal contraception, with the pill being a favourable option.

## Follow ups
This data set can lend itself to many visualisations. For example, plotting the different age categories can give insight into favourable contraceptive methods for different age groups, could younger generations be using less or more hormonal contraception? and if so, which one appears to be popular? 
Looking into different continents or specific countries can also be done as a follow-up, it is possible different countries favour different methods.
There are a wide range of measures in the data set and thus, many other measures can be investigated, not just the 5 chosen out of pure curiosity. 

## Reflection
If given more time, I would have liked to merge both of the available data sets to investigate since the 70's. I did not do this because the one data set used was large, and frankly was scary!
However, I have learnt a lot doing this project, I am very proud of my visualisation and the fun things that I incorporated like the colour of the pill packaging. I thought it was ambitious to make a moving graph at the start of the module and so I am proud to have completed one. 

# References:
Haakenstad, A., Angelino, O., Irvine, C. M. S., Bhutta, Z. A., Bienhoff, K., Bintz, C., Causey, K., Dirac, M. A., Fullman, N., Gakidou, E., Glucksman, T., Hay, S. I., Henry, N. J., Martopullo, I., Mokdad, A. H., Mumford, J. E., Lim, S. S., Murray, C. J. L., & Lozano, R. (2022). Measuring contraceptive method mix, prevalence, and demand satisfied by age and marital status in 204 countries and territories, 1970–2019: a systematic analysis for the Global Burden of Disease Study 2019. The Lancet, 400(10348), 295–327. https://doi.org/10.1016/S0140-6736(22)00936-9


The data, code and original code book can be found via this website: https://ghdx.healthdata.org/record/ihme-data/contraceptive-prevalence-estimates-1970-2019
Global Burden of Disease Collaborative Network. Global Burden of Disease Study 2019 (GBD 2019) Contraceptive Prevalence Estimates 1970-2019. Seattle, United States of America: Institute for Health Metrics and Evaluation (IHME), 2022.
